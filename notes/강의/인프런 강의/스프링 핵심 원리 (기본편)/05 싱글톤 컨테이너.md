### 웹 애플리케이션과 싱글톤
싱글톤 패턴은 객체가 java jvm 안에 딱 하나만 있어야 하는 패턴.

![[Pasted image 20231110111940.png]]
웹 애플리케이션은 고객에 끊임없이 요청을 한다. 
요청을 할 때마다 객체가 생성되는 문제가 생긴다. 

![[Pasted image 20231110112411.png]]
이런식으로 생성할 때마다 객체가 생기고 계속 jvm 메모리에 올라가게 된다. 
예를 들어 고객 트래픽이 초당 100이 나오면 초당 100개의 객체가 생성되고 소멸된다는 것.
해결방안은 해당 객체가 딱 1개만 생성되고 공유하도록 설계하면 된다. 이것이 싱글톤 패턴.


### 싱글톤 패턴
싱글톤 패턴이란 한 jvm 안에서 하나의 객체 인스턴스만 생성이 되는 패턴.
방법은 객체 인스턴스를 2개 이상 생성하지 못하도록 막는 것.

지금껏 만든 AppConfig의 객체를 모두 싱글톤 패턴을 적용하기 위해 .getinstance()를 붙여줘야 할까? 그럴 필요 없다.
스프링 컨테이너가 기본적으로 객체를 다 싱글톤으로 만들어서 관리해준다. 
요청이 100개가 들어와도 새로 만드는 객체는 없다. 하나의 객체로 요청에 대응한다. 
하지만 싱글톤 패턴도 문제점이 많다.

```
private static final SingletonService instance = new SingletonService();  
public static SingletonService getInstance() {  
    return instance;  
}
```
위 코드를 항상 넣어줘야 한다. 

![[Pasted image 20231121205537.png]]

### 싱글톤 컨테이너
싱글톤 컨테이너의 장점은 싱글톤 패턴을 위해 적어주어야 했던 코드를 넣지 않아도 된다. 

### 싱글톤 방식의 주의점
싱글톤 방식은 여러 클라이언트가 하나의 객체 인스턴스를 공유하기 때문에 싱글톤 객체는 상태를 유지(stateful)하게 설계하면 안된다. 따라서 무상태(stateless)로 설계해야 한다.

StatefulServiceTest 참고.
![[Pasted image 20231121211931.png]]

### @Configuration과 싱글톤
@Configuration은 싱글톤을 위해 존재한다. 
![[Pasted image 20231121214435.png]]

### @Configuration과 바이트코드 조작의 마법
스프링 컨테이너는 싱글톤 레지스트리다. 
하지만 스프링이 자바 코드까지 조작하기는 어렵다.
(ppt 참고) 자바 코드를 보면 3번 호출되어야 하는 것이 맞다.
스프링은 클래스의 바이트코드를 조작하는 라이브러리를 사용하여 이를 해결한다.

![[Pasted image 20231121215804.png]]
AppConfig 스프링 빈을 조회해서 출력하면  class hello.core.AppConfig로 나타나지 않는다.
CGLIB라는 바이트코드 조작 라이브러리를 사용해서 AppConfig 클래스를 상속받은 임의의 다른 클래스를 만들고, 그 다른 클래스를 스프링 빈으로 등록한 것.


@Configuration을 추가하지 않고 @Bean만 추가하는 경우 에러가 나지 않지만 싱글톤을 보장하지 않는다.
@Autowried를 붙여 해결하는 것도 가능하다. 